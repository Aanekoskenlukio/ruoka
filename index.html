<html>
  <head>
    <meta charset="utf-8">
    <title>Äänekosken lukion ruokalista</title>
    <link
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    rel="stylesheet">
    <script
    src="https://code.jquery.com/jquery-3.3.1.js"
    integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
    crossorigin="anonymous">
    </script>
    <style media="screen">
      h1 {
        font-size:100px !important;
        margin:50px auto;
      }
      .food-menu {
        font-size:49px;
      }
      .menu-container {
        width:95%;
        margin:0px auto;
      }
      u {
        text-decoration:none; 
      }
      i {
        color:forestgreen;
        font-size:29px;
      }
    </style>
    <script type="text/javascript">
    setInterval(function() {
      window.location.reload();
    }, 400000);
    </script>
  </head>
  <body>
    <div class="menu-container">
      <div class="rows">
        <h1 id="ot" class="text-primary">Tarjolla 07.03.</h1>
        <hr>
      </div>
      <br>
      <div class="row">
        <div class="col food-menu" id="ruoka">
        </div>
        <div class="col food-menu" id="kasvis">
        </div>
      </div>
      <div class="row">
        <div class="col">
          <br>
          <span>Huomenna: </span><span class="text-primary" id="tm"></span>
        </div>
      </div>
    </div>
    <script type="text/javascript">
    //Päivämäärän laskenta
    var today = new Date();
    var dd = today.getDate();
    var mm = today.getMonth()+1; //Tammikuu on 0:s kuukausi
    var yyyy = today.getFullYear();

    if(dd<10) {
        dd = '0'+dd
    }
    if(mm<10) {
        mm = '0'+mm
    }

    pvm = yyyy+mm+dd;
    //pvm = "20180308";
    console.log("Tänään on " + pvm);

    var r = document.getElementById('ruoka');
    var k = document.getElementById('kasvis');
    var ot = document.getElementById('ot');
    var hu = document.getElementById('tm');
    var url = "http://crossorigin.me/http://www.jamix.fi/ruokalistapalvelu/rest/haku/menu/95710/8?lang=fi&date=";
    var dataObj = {};
    $.get(url + pvm, function(data)
    {
      console.log(data);
      if (data == "[]") {
        r.innerHTML = "<br>Tarjolla vain ei-oota...<br>Ruokailussa poikkeuksia tai järjestelmässä tapahtui virhe.</small>";
        ot.innerHTML = "Virhe!";
        r.style.color = "orange";
      } else {
        ot.innerHTML = "Tarjolla " + dd + "." + mm + ".";
        //dataObj = JSON.parse(data);
        dataObj = data; //Miksi toimii?? EI TIETOA
        var dataPerus = dataObj[0]["menuTypes"][0]["menus"][0]["days"][0]["mealoptions"][0]["menuItems"];
        var dataKasvis = dataObj[0]["menuTypes"][2]["menus"][0]["days"][0]["mealoptions"][0]["menuItems"];

        var lista = [];
        var allergiat = [];
        var aineet = [];
        var aine = "";
        
        var url2 = "http://crossorigin.me/http://www.jamix.fi/ruokalistapalvelu/rest/haku/menu/95710/8?lang=fi&date=";
        var pvm2 = "20180307";
        $.get(url2 + pvm2, function(data2) {
          if (data2 == "[]") {
            hu.innerHTML = "virhe (2)";
          } else {
            var ruokaHuomenna = data2[0]["menuTypes"][0]["menus"][0]["days"][0]["mealoptions"][0]["menuItems"][0]["name"];
            console.log(ruokaHuomenna);
          }
        }).fail(function() {
          hu.innerHTML = "virhe (1)";
        });;
        
        var huomenna = dataPerusHuomenna[0]["name"];

        for (var i = 0; i < dataPerus.length; i++) {
          lista.push(dataPerus[i]["name"]);
          allergiat.push(dataPerus[i]["diets"]);

          aine = dataPerus[i]["ingredients"].split(": ")[1];
          aine = aine.split(",")[0];
          aineet.push(aine);
        }
        
        for (var j = 0; j < lista.length; j++) {
          if (j == 0 || j == 1 || j == 2) {
            r.innerHTML += "<u>" + lista[j] + "</u> <i>" + allergiat[j] + "</i>" + "<br>";
          } else {
            r.innerHTML += lista[j] + " <i>" + allergiat[j] + "</i>" + "<br>"; 
          }
        }
        
        lista = [];
        allergiat = [];
        aineet = [];
        aine = "";
        
        for (var i = 0; i < dataKasvis.length; i++) {
          lista.push(dataKasvis[i]["name"]);
          allergiat.push(dataKasvis[i]["diets"]);

          aine = dataKasvis[i]["ingredients"].split(": ")[1];
          aine = aine.split(",")[0];
          aineet.push(aine);
        }

        for (var j = 0; j < lista.length; j++) {
          if (j == 0 || j == 1 || j == 2) {
            k.innerHTML += "<u>" + lista[j] + "</u> <i>" + allergiat[j] + "</i>" + "<br>";
          } else {
            k.innerHTML += lista[j] + " <i>" + allergiat[j] + "</i>" + "<br>"; 
          }
        }
        
      }
    }).fail(function() {
      r.innerHTML = "<br>Ruokalistaa ei voitu hakea.<br><small>Tämä on 404. JSON-tiedostoa ei löytynyt.</small>";
      ot.innerHTML = "Beep-boop!";
      r.style.color = "red";
    });
    </script>
  </body>
</html>
